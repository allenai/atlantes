"""Utilities for reading and writing track incremental data
"""

from datetime import datetime

import numpy as np
import spatialpandas as sp
from pandera import DataFrameModel


class BaseDataModel(DataFrameModel):
    """Base schema for ATLAS Input files"""

    class Config:
        """Config for TrackfileDataModel"""

        coerce = True  # ensure that columns are coerced to the correct type
        strict = False  # allow extra columns


GCP_TRACK_DATA_BUCKET = "ais-track-data"
DT_STRING = datetime.now().strftime("%d-%m-%Y-%H-%M-%S")
META_DATA_INDEX_2022_PATH = (
    "gs://ais-track-data/2022/metadata_index_all_2022_tracks_w_subpaths.parquet"
)
META_DATA_INDEX_2023_PATH = (
    "gs://ais-track-data/2023/metadata_index_ais_2023_subpath.parquet"
)
ALL_META_DATA_INDEX_PATHS = [META_DATA_INDEX_2022_PATH, META_DATA_INDEX_2023_PATH]

DATE_FORMAT = "%Y-%m-%dT%H:%M:%SZ"  # this is the date format used in the AIS data
EXAMPLE = sp.GeoDataFrame(
    {
        "geometry": sp.geometry.PointArray([], dtype="float32"),
        "mmsi": np.array([], dtype="int32"),
        "category": np.array([], dtype="int32"),
        "nav": np.array([], dtype="int32"),
        "trackId": np.array([], dtype="str"),
        "name": np.array([], dtype="str"),
        "send": np.array([], dtype="str"),
        "lon": np.array([], dtype="float32"),
        "lat": np.array([], dtype="float32"),
        "sog": np.array([], dtype="float64"),
        "cog": np.array([], dtype="float64"),
        "flag_code": np.array([], dtype="str"),
        "vessel_class": np.array([], dtype="str"),
        "dist2coast": np.array([], dtype="float32"),
    }
)

EXAMPLE_NO_META = sp.GeoDataFrame(
    {
        "geometry": sp.geometry.PointArray([], dtype="float32"),
        "mmsi": np.array([], dtype="int32"),
        "nav": np.array([], dtype="int32"),
        "trackId": np.array([], dtype="str"),
        "send": np.array([], dtype="str"),
        "lon": np.array([], dtype="float32"),
        "lat": np.array([], dtype="float32"),
        "sog": np.array([], dtype="float64"),
        "cog": np.array([], dtype="float64"),
        "dist2coast": np.array([], dtype="float32"),
    }
)
DF_COL_DTYPES = {
    "name": "object",
    "flag_code": "object",
    "vessel_class": "object",
}

DFCOLS = [
    "trackId",
    "mmsi",
    "lon",
    "lat",
    "ais_type",  # Turned into category eventually to correspond to AIS_categories.csv
    "name",
    "nav",
    "send",
    "sog",
    "cog",
    "flag_code",
    "vessel_class",
    "dist2coast",
]

DFCOLS_NO_META = [
    "trackId",
    "mmsi",
    "lon",
    "lat",
    "nav",
    "send",
    "sog",
    "cog",
    "dist2coast",
]

NAV_NAN = 9999
VES_NAN = 9999
KNOTS_TO_MPS = 0.514444444
MAX_VESSEL_SPEED = 40  # knots
UNKNOWN_SOG = 102.3  # m/s
UNKNOWN_COG = 511  # degrees

MONTHS_TO_LOAD = [
    "01",
    "02",
    "03",
    "04",
    "05",
    "06",
    "07",
    "08",
    "09",
    "10",
    "11",
    "12",
]

# TODO: Hacky fix because I discovered a missing file in all 2022 and not worth the time to regenerate right now
DATASET_NAME_2022 = "all_2022_tracks_w_subpaths"
DATASET_NAME_2022_OLD = "trajectory_with_subpath_monthly"
GCP_BUCKET_NAME_AIS_TRACKS = "ais-track-data"

# Sourced from https://documentation.spire.com/ais-fundamentals/vessel-flag-codes/ and skylight 3 letter codes
MMSI_FLAG_CODES = {
    "412": "CHN",
    "518": "COK",
    "477": "HKG",
    "413": "CHN",
    "656": "NER",
    "419": "IND",
    "244": "NLD",
    "246": "NLD",
    "258": "NOR",
    "273": "RUS",
    "735": "ECU",
    "373": "PAN",
    "374": "PAN",
    "209": "CYP",
    "308": "BHS",
    "368": "USA",
    "354": "PAN",
    "533": "MYS",
    "254": "MCO",
    "235": "GBR",
    "416": "TWN",
    "265": "SWE",
    "574": "VNM",
    "245": "NLD",
    "228": "FRA",
    "366": "USA",
    "348": "MSR",
    "247": "ITA",
    "540": "NCL",
    "201": "ALB",
    "351": "PAN",
    "525": "IDN",
    "212": "CYP",
    "431": "JPN",
    "661": "RWA",
    "338": "USA",
    "347": "MTQ",
    "353": "PAN",
    "565": "SGP",
    "229": "MLT",
    "572": "TUV",
    "211": "DEU",
    "367": "USA",
    "636": "LBR",
    "408": "BHR",
    "214": "MDA",
    "503": "AUS",
    "227": "FRA",
    "634": "KEN",
    "248": "MLT",
    "312": "BLZ",
    "370": "PAN",
    "243": "HUN",
    "538": "MHL",
    "506": "MMR",
    "219": "DNK",
    "305": "ATG",
    "304": "ATG",
    "669": "SWZ",
    "316": "CAN",
    "443": "PSE",
    "563": "SGP",
    "612": "CAF",
    "327": "DOM",
    "710": "BRA",
    "645": "MUS",
    "440": "KOR",
    "566": "SGP",
    "725": "CHL",
    "356": "PAN",
    "257": "NOR",
    "422": "IRN",
    "414": "CHN",
    "309": "BHS",
    "659": "NAM",
    "635": "ATF",
    "701": "ARG",
    "232": "GBR",
    "403": "SAU",
    "205": "BEL",
    "605": "DZA",
    "239": "GRC",
    "621": "DJI",
    "730": "COL",
    "311": "BHS",
    "259": "NOR",
    "251": "ISL",
    "548": "PHL",
    "240": "GRC",
    "234": "GBR",
    "425": "IRQ",
    "256": "MLT",
    "355": "PAN",
    "542": "NIU",
    "241": "GRC",
    "760": "PER",
    "512": "NZL",
    "664": "SYC",
    "576": "VUT",
    "306": "CUW",
    "601": "ZAF",
    "622": "EGY",
    "206": "BLR",
    "331": "GRL",
    "252": "LIE",
    "352": "PAN",
    "372": "PAN",
    "319": "CYM",
    "310": "BMU",
    "271": "TUR",
    "375": "VCT",
    "613": "CMR",
    "341": "KNA",
    "633": "BFA",
    "220": "DNK",
    "224": "ESP",
    "755": "PRY",
    "225": "ESP",
    "266": "SWE",
    "339": "JAM",
    "371": "PAN",
    "510": "FSM",
    "671": "TGO",
    "255": "PRT",
    "307": "ABW",
    "369": "USA",
    "357": "PAN",
    "314": "BRB",
    "233": "GBR",
    "663": "SEN",
    "567": "THA",
    "607": "ATF",
    "325": "DMA",
    "215": "MLT",
    "544": "NRU",
    "432": "JPN",
    "441": "KOR",
    "514": "KHM",
    "473": "YEM",
    "207": "BGR",
    "478": "BIH",
    "564": "SGP",
    "269": "CHE",
    "332": "GTM",
    "631": "GNQ",
    "657": "NGA",
    "376": "VCT",
    "359": "SLV",
    "665": "SHN",
    "647": "MDG",
    "362": "TTO",
    "637": "LBR",
    "210": "CYP",
    "249": "MLT",
    "218": "DEU",
    "625": "ERI",
    "417": "LKA",
    "236": "GIB",
    "740": "FLK",
    "765": "SUR",
    "278": "SVN",
    "423": "AZE",
    "378": "VGB",
    "202": "AND",
    "546": "PYF",
    "654": "MRT",
    "463": "PAK",
    "379": "VIR",
    "303": "USA",
    "620": "COM",
    "336": "HTI",
    "644": "LSO",
    "471": "ARE",
    "208": "VAT",
    "253": "LUX",
    "377": "VCT",
    "450": "LBN",
    "451": "KGZ",
    "453": "MAC",
    "226": "FRA",
    "603": "AGO",
    "619": "CIV",
    "275": "LVA",
    "529": "KIR",
    "434": "TKM",
    "230": "FIN",
    "445": "PRK",
    "638": "SSD",
    "262": "MNE",
    "466": "QAT",
    "405": "BGD",
    "277": "LTU",
    "677": "TZA",
    "263": "PRT",
    "520": "FJI",
    "610": "BEN",
    "770": "URY",
    "250": "IRL",
    "204": "AZR",
    "470": "ARE",
    "511": "PLW",
    "334": "HND",
    "237": "GRC",
    "611": "BWA",
    "660": "REU",
    "472": "TJK",
    "261": "POL",
    "667": "SLE",
    "475": "YEM",
    "216": "ARM",
    "323": "CUB",
    "321": "CRI",
    "674": "TZA",
    "675": "UGA",
    "203": "AUT",
    "668": "STP",
    "213": "GEO",
    "457": "MNG",
    "350": "NIC",
    "676": "COD",
    "626": "GAB",
    "276": "EST",
    "561": "WSM",
    "345": "MEX",
    "666": "SOM",
    "461": "OMN",
    "670": "TCD",
    "268": "SMR",
    "242": "MAR",
    "775": "VEN",
    "231": "FRO",
    "577": "VUT",
    "630": "GNB",
    "455": "MDV",
    "428": "ISR",
    "410": "BTN",
    "720": "BOL",
    "301": "AIA",
    "436": "KAZ",
    "447": "KWT",
    "553": "PNG",
    "578": "WLF",
    "274": "MKD",
    "272": "UKR",
    "330": "GRD",
    "358": "PRI",
    "672": "TUN",
    "279": "SRB",
    "678": "ZMB",
    "557": "SLB",
    "270": "CZE",
    "515": "KHM",
    "343": "LCA",
    "615": "COG",
    "516": "CXR",
    "627": "GHA",
    "536": "MNP",
    "501": "ATA",
    "555": "PCN",
    "642": "LBY",
    "655": "MWI",
    "238": "HRV",
    "523": "CCK",
    "401": "AFG",
    "662": "SDN",
    "624": "ETH",
    "609": "BDI",
    "267": "SVK",
    "608": "ASC",
    "617": "CPV",
    "632": "GIN",
    "679": "ZWE",
    "570": "TON",
    "745": "GUF",
    "364": "TCA",
    "650": "MOZ",
    "264": "ROU",
    "629": "GMB",
    "329": "GLP",
    "508": "BRN",
    "618": "ATF",
    "468": "SYR",
    "616": "COM",
    "531": "LAO",
    "361": "SPM",
    "649": "MLI",
    "437": "UZB",
    "438": "JOR",
    "459": "NPL",
    "559": "ASM",
    "750": "GUY",
}
